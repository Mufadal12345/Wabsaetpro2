<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ± - Firebase Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        .main-bg { background: linear-gradient(135deg, #1f2937 0%, #171717 100%); }
        .section-body-rendered p { margin-bottom: 1rem; }
        .section-body-rendered strong { font-weight: bold; }
        .section-body-rendered ul { list-style: disc; margin-right: 1.5rem; margin-bottom: 1rem;}
        .section-body-rendered .highlight-quote {
            border-right: 4px solid #f59e0b; background-color: #fffbeb;
            padding: 1rem; margin: 1rem 0; font-size: 1.25rem; font-style: italic;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: #1f2937;
        }
        .editor-textarea { min-height: 150px; }
        /* Scrollbar styles for modals */
        .modal-scroll::-webkit-scrollbar { width: 8px; }
        .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .modal-scroll::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="main-bg min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-4xl bg-stone-100 shadow-2xl rounded-xl p-6 md:p-10 transition-all duration-500 relative">
        
        <div id="global-message" class="hidden fixed top-4 right-4 p-4 rounded-lg shadow-xl z-50 text-white transition-opacity duration-500">
            <p id="global-message-text" class="font-bold"></p>
        </div>

        <div id="loader" class="flex flex-col items-center justify-center h-96 text-gray-700">
            <svg class="animate-spin h-10 w-10 text-blue-800 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firebase)...</p>
        </div>

        <div id="registration-view" class="hidden">
            <h1 class="text-3xl font-extrabold text-blue-900 mb-6 text-center">Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ±</h1>
            <p class="text-gray-600 mb-8 text-center">Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„ØªØµÙØ­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£Ùˆ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ±.</p>
            <form id="registration-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ø§Ù„Ø§Ø³Ù…</label>
                    <input type="text" id="name" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-800 focus:border-blue-800">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ø§Ù„ØªØ®ØµØµ / Ø§Ù„ÙƒÙˆØ¯</label>
                    <input type="text" id="specialty" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-800 focus:border-blue-800">
                </div>
                <button type="submit" id="login-btn" class="w-full py-3 px-4 bg-blue-800 text-white rounded-lg hover:bg-blue-900 font-bold shadow-lg transition">
                    Ø¯Ø®ÙˆÙ„
                </button>
            </form>
        </div>

        <div id="home-view" class="hidden">
            <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-300">
                <h1 class="text-2xl font-bold text-blue-900">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="user-display-name"></span></h1>
                <button onclick="window.location.reload()" class="text-sm text-red-600 hover:text-red-800">Ø®Ø±ÙˆØ¬</button>
            </div>
            
            <div id="main-menu">
                <div class="text-center mb-6 p-4 bg-stone-200 rounded-lg">
                    <h2 class="text-3xl font-extrabold text-blue-900">ğŸ›ï¸ Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ±</h2>
                    <p class="text-gray-600">Ø­ÙŠØ« ØªØ®Ù„Ø¯ Ø§Ù„Ø£ÙÙƒØ§Ø±</p>
                </div>
                <div id="dynamic-sections-list" class="space-y-3"></div>
            </div>

            <div id="section-content" class="hidden bg-stone-200 p-6 rounded-lg shadow-inner">
                <button onclick="globalApp.changeView('main-menu')" class="mb-4 text-blue-700 hover:underline">â† Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                <h2 id="section-title" class="text-3xl font-bold text-gray-800 mb-4 border-b pb-2 border-gray-400"></h2>
                <div id="section-body" class="text-gray-700 leading-relaxed text-lg text-right section-body-rendered"></div>
            </div>
        </div>

        <div id="management-view" class="hidden">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-rose-200">
                <h1 class="text-2xl font-bold text-rose-800">ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
                <div class="flex gap-2">
                    <button onclick="globalApp.openMembersModal()" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
                    <button onclick="window.location.reload()" class="text-sm text-rose-700 hover:text-rose-900">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
            
            <button onclick="globalApp.openEditorModal('new')" class="w-full mb-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 shadow-md font-bold">
                + Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯
            </button>

            <div class="space-y-3" id="editable-sections-list"></div>
        </div>

        <div id="editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto modal-scroll">
                <h2 id="editor-title-text" class="text-2xl font-bold text-blue-900 mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…</h2>
                <form id="section-editor-form" class="space-y-4">
                    <input type="hidden" id="editor-doc-id">
                    <input type="hidden" id="editor-type">
                    <input type="number" id="editor-order" placeholder="Ø§Ù„ØªØ±ØªÙŠØ¨" class="w-20 px-2 py-1 border rounded hidden"> 
                    
                    <div>
                        <label class="block text-sm font-medium">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</label>
                        <input type="text" id="editor-menu-title" required class="w-full px-3 py-2 border rounded focus:ring-2 ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" id="editor-full-title" required class="w-full px-3 py-2 border rounded focus:ring-2 ring-blue-500">
                    </div>
                    
                    <div id="dynamic-editor-fields" class="space-y-4 bg-gray-50 p-4 rounded border"></div>
                    
                    <div class="flex justify-end gap-3 mt-4">
                        <button type="button" onclick="document.getElementById('editor-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" id="editor-save-btn" class="px-4 py-2 bg-blue-800 text-white rounded hover:bg-blue-900">Ø­ÙØ¸ ÙÙŠ Firebase</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="members-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold text-blue-900">ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù†Ø¶Ù…ÙˆÙ†</h2>
                    <button onclick="document.getElementById('members-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>
                <div id="members-list-container" class="overflow-y-auto modal-scroll flex-1 pr-2">
                    <p class="text-center text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
                <div class="mt-4 pt-2 border-t text-sm text-gray-500 text-center">
                    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: <span id="members-count" class="font-bold text-blue-600">0</span>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // 1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, setDoc, doc, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Config)
        const firebaseConfig = {
            apiKey: "AIzaSyB8JN73w75NQB7MifQMdOl1VcwifklyVZU",
            authDomain: "newpro-d5360.firebaseapp.com",
            databaseURL: "https://newpro-d5360-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "newpro-d5360",
            storageBucket: "newpro-d5360.firebasestorage.app",
            messagingSenderId: "732050035324",
            appId: "1:732050035324:web:5a38e03134de3b287b2ff9",
            measurementId: "G-9TYX1QYJQG"
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
        const ADMIN_CREDENTIALS = { name: "Rasha", specialty: "20250929" };

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ)
        const templates = {
            'basic_highlight': {
                editorFields: [
                    { key: 'p1', label: 'Ø§Ù„ÙÙ‚Ø±Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©', type: 'textarea' },
                    { key: 'p2', label: 'Ø§Ù„ÙÙ‚Ø±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©', type: 'textarea' },
                    { key: 'p3_highlight', label: 'Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¨Ø§Ø±Ø²Ø©', type: 'textarea' },
                    { key: 'p4', label: 'Ø§Ù„Ø®ØªØ§Ù…', type: 'textarea' }
                ],
                render: (f) => `<p class="text-xl">${f.p1}</p><p class="mt-4">${f.p2}</p><p class="mt-4 text-2xl font-extrabold text-blue-900 border-b-2 border-amber-500 pb-2">${f.p3_highlight}</p><p class="mt-4 text-lg text-amber-600">${f.p4}</p>`
            },
            'list_items': {
                 editorFields: [
                    { key: 'intro', label: 'Ù…Ù‚Ø¯Ù…Ø©', type: 'textarea' },
                    { key: 'listTitle', label: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', type: 'input' },
                    { key: 'listItems', label: 'Ø§Ù„Ø¹Ù†Ø§ØµØ± (ÙƒÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ø³Ø·Ø±)', type: 'textarea' }
                ],
                render: (f) => {
                    const items = (f.listItems || '').split('\n').filter(i => i.trim());
                    const listHtml = items.map(i => `<li class="flex items-start mb-2"><span class="ml-2 text-blue-600">ğŸ”¹</span><span>${i}</span></li>`).join('');
                    return `<p class="text-xl">${f.intro}</p><p class="mt-4 font-bold text-lg">${f.listTitle}</p><ul class="mt-2">${listHtml}</ul>`;
                }
            },
            'quote_block': {
                editorFields: [
                    { key: 'p1', label: 'Ø§Ù„ÙÙ‚Ø±Ø©', type: 'textarea' },
                    { key: 'quote', label: 'Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³', type: 'textarea' }
                ],
                render: (f) => `<p class="text-xl">${f.p1}</p><blockquote class="highlight-quote">${f.quote}</blockquote>`
            },
             'final_call': {
                 editorFields: [
                    { key: 'call_title', label: 'Ø§Ù„Ø¯Ø¹ÙˆØ©', type: 'textarea' },
                    { key: 'final_signature', label: 'Ø§Ù„ØªÙˆÙ‚ÙŠØ¹', type: 'input' }
                ],
                render: (f) => `<div class="p-6 bg-blue-100 rounded-xl text-center"><p class="text-3xl font-extrabold text-blue-900">${f.call_title}</p></div><p class="mt-8 text-2xl font-bold text-center">ğŸ“ ${f.final_signature}</p>`
            }
        };

        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let globalSections = [];
        window.globalApp = {}; // Ù„Ø±Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„ÙˆØ¸Ø§Ø¦Ù

        // ==========================================
        //  ÙˆØ¸Ø§Ø¦Ù Firebase Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        // ==========================================

        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        async function fetchSections() {
            try {
                const q = query(collection(db, "sections"), orderBy("order"));
                const querySnapshot = await getDocs(q);
                globalSections = [];
                querySnapshot.forEach((doc) => {
                    globalSections.push({ id: doc.id, ...doc.data() });
                });
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙØ§Ø±ØºØ© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ Ù‚Ù… Ø¨Ù…Ù„Ø¦Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                if (globalSections.length === 0) {
                    await seedInitialData(); 
                }
                return globalSections;
            } catch (error) {
                console.error("Error fetching sections:", error);
                showMessage("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
                return [];
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ÙØ§Ø±ØºØ© (Seeding)
        async function seedInitialData() {
            const initialData = [
                { order: 1, menuTitle: 'ğŸ§­ Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ', title: 'ğŸ§­ Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù‡Ù…ØŸ', type: 'basic_highlight', fields: { p1: "ÙÙŠ ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ø¹Ø§Ù„Ù… ØºÙŠØ± Ù…ÙƒØªØ´Ù.", p2: "Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ± Ù„ÙŠØ³ Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ Ø¹Ø§Ø¯ÙŠØ§Ù‹...", p3_highlight: "Ø¥Ù†Ù‡ Ù…Ù†ØµØ© ØªØµÙ†Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø®ØµÙŠ.", p4: "Ù†Ø­ÙˆÙ„ Ø§Ù„Ø£ÙÙƒØ§Ø± Ø¥Ù„Ù‰ Ø£Ø«Ø±." }},
                { order: 2, menuTitle: 'ğŸ›ï¸ Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…ØªØ­ÙØŸ', title: 'ğŸ›ï¸ Ù…Ø§ Ù‡Ùˆ Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ±ØŸ', type: 'list_items', fields: { intro: "Ù…Ø³Ø§Ø­Ø© Ø­Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©.", listTitle: "ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:", listItems: "Ø£ÙÙƒØ§Ø±\nÙ„ÙˆØ­Ø§Øª\nØ§Ù‚ØªØ¨Ø§Ø³Ø§Øª" }},
                { order: 3, menuTitle: 'âœ¨ Ø¯Ø¹ÙˆØ© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©', title: 'âœ¨ Ø´Ø§Ø±ÙƒÙ†Ø§ ÙÙƒØ±Ùƒ', type: 'final_call', fields: { call_title: "Ø§ØªØ±Ùƒ Ø£Ø«Ø±Ø§Ù‹ ÙŠØ´Ø¨Ù‡Ùƒ.", final_signature: "Ù…ØªØ­Ù Ø§Ù„ÙÙƒØ±" }}
            ];
            
            showMessage("Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©...", "info");
            for (const item of initialData) {
                await addDoc(collection(db, "sections"), item);
            }
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø¨
            const q = query(collection(db, "sections"), orderBy("order"));
            const querySnapshot = await getDocs(q);
            globalSections = [];
            querySnapshot.forEach((doc) => globalSections.push({ id: doc.id, ...doc.data() }));
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙˆØ§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø­ÙØ¸ Ø§Ù„Ø¹Ø¶Ùˆ)
        async function registerUser(name, specialty) {
            try {
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ÙƒÙˆÙ„ÙƒØ´Ù† 'users'
                await addDoc(collection(db, "users"), {
                    name: name,
                    specialty: specialty,
                    loginTime: serverTimestamp()
                });
                console.log("User registered in DB");
            } catch (e) {
                console.error("Error logging user:", e);
            }
        }

        // Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù„Ù„Ù…Ø¯ÙŠØ±
        window.globalApp.openMembersModal = async () => {
            const modal = document.getElementById('members-modal');
            const listContainer = document.getElementById('members-list-container');
            const countSpan = document.getElementById('members-count');
            
            modal.classList.remove('hidden');
            listContainer.innerHTML = '<div class="flex justify-center p-4"><svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

            try {
                // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø£Ø­Ø¯Ø«
                const q = query(collection(db, "users"), orderBy("loginTime", "desc"));
                const querySnapshot = await getDocs(q);
                
                listContainer.innerHTML = '';
                let count = 0;

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ù†Ø¶Ù…ÙŠÙ† Ø¨Ø¹Ø¯.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        count++;
                        const data = doc.data();
                        const time = data.loginTime ? new Date(data.loginTime.toDate()).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                        
                        const item = document.createElement('div');
                        item.className = 'flex justify-between items-center p-3 border-b hover:bg-gray-50';
                        item.innerHTML = `
                            <div>
                                <p class="font-bold text-gray-800">${data.name}</p>
                                <p class="text-xs text-gray-500">${data.specialty}</p>
                            </div>
                            <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">${time}</span>
                        `;
                        listContainer.appendChild(item);
                    });
                }
                countSpan.textContent = count;
            } catch (error) {
                console.error(error);
                listContainer.innerHTML = '<p class="text-red-500 text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
            }
        };

        // ==========================================
        //  Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (UI Logic)
        // ==========================================

        function showMessage(msg, type = 'success') {
            const box = document.getElementById('global-message');
            const text = document.getElementById('global-message-text');
            box.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl z-50 text-white transition-opacity duration-500 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            text.textContent = msg;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        window.onload = async () => {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('registration-view').classList.remove('hidden');
        };

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('registration-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...';
            btn.disabled = true;

            const name = document.getElementById('name').value.trim();
            const specialty = document.getElementById('specialty').value.trim();

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Firebase
            await fetchSections();

            document.getElementById('registration-view').classList.add('hidden');

            // ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¯ÙŠØ±
            if (name === ADMIN_CREDENTIALS.name && specialty === ADMIN_CREDENTIALS.specialty) {
                renderAdminList();
                document.getElementById('management-view').classList.remove('hidden');
                showMessage("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ±", "success");
            } else {
                // Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ + ØªØ³Ø¬ÙŠÙ„Ù‡ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
                await registerUser(name, specialty);
                document.getElementById('user-display-name').textContent = name;
                renderUserList();
                document.getElementById('home-view').classList.remove('hidden');
            }
        });

        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function renderUserList() {
            const container = document.getElementById('dynamic-sections-list');
            container.innerHTML = '';
            globalSections.forEach(sec => {
                const div = document.createElement('div');
                div.className = 'cursor-pointer p-4 bg-white hover:bg-blue-50 rounded-xl shadow border-r-4 border-blue-600 transition';
                div.innerHTML = `<h3 class="font-bold text-blue-900">${sec.menuTitle}</h3>`;
                
                // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù€ HTML
                const tpl = templates[sec.type] || templates['basic_highlight'];
                const html = tpl.render(sec.fields);

                div.onclick = () => {
                    document.getElementById('section-title').textContent = sec.title;
                    document.getElementById('section-body').innerHTML = html;
                    document.getElementById('main-menu').classList.add('hidden');
                    document.getElementById('section-content').classList.remove('hidden');
                };
                container.appendChild(div);
            });
        }

        window.globalApp.changeView = (view) => {
            if(view === 'main-menu') {
                document.getElementById('section-content').classList.add('hidden');
                document.getElementById('main-menu').classList.remove('hidden');
            }
        };

        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø¯ÙŠØ±
        function renderAdminList() {
            const container = document.getElementById('editable-sections-list');
            container.innerHTML = '';
            globalSections.forEach(sec => {
                const div = document.createElement('div');
                div.className = 'flex justify-between p-4 bg-white rounded shadow border-r-4 border-rose-500';
                div.innerHTML = `
                    <span>${sec.order}. ${sec.menuTitle}</span>
                    <button onclick="globalApp.openEditorModal('${sec.id}')" class="text-sm bg-gray-200 px-2 rounded hover:bg-gray-300">ØªØ¹Ø¯ÙŠÙ„</button>
                `;
                container.appendChild(div);
            });
        }

        // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (ØªØ¹Ø¯ÙŠÙ„/Ø¥Ø¶Ø§ÙØ©)
        window.globalApp.openEditorModal = (id) => {
            const form = document.getElementById('section-editor-form');
            form.reset();
            const isNew = id === 'new';
            document.getElementById('editor-doc-id').value = isNew ? '' : id;
            document.getElementById('editor-modal').classList.remove('hidden');
            document.getElementById('editor-title-text').textContent = isNew ? 'Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯' : 'ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…';
            
            let data = isNew 
                ? { type: 'basic_highlight', menuTitle: '', title: '', fields: {}, order: globalSections.length + 1 }
                : globalSections.find(s => s.id === id);

            document.getElementById('editor-menu-title').value = data.menuTitle;
            document.getElementById('editor-full-title').value = data.title;
            document.getElementById('editor-order').value = data.order;
            document.getElementById('editor-type').value = data.type; // Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§ (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡ Ù„ÙŠÙƒÙˆÙ† Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø©)

            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„
            const fieldsContainer = document.getElementById('dynamic-editor-fields');
            fieldsContainer.innerHTML = '';
            const tpl = templates[data.type] || templates['basic_highlight'];
            document.getElementById('editor-type').value = data.type; // Ø­ÙØ¸ Ø§Ù„Ù†ÙˆØ¹

            tpl.editorFields.forEach(field => {
                const div = document.createElement('div');
                const label = document.createElement('label');
                label.className = "block text-sm text-gray-600 mb-1";
                label.textContent = field.label;
                
                let input;
                if(field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.className = "w-full p-2 border rounded h-24";
                } else {
                    input = document.createElement('input');
                    input.type = "text";
                    input.className = "w-full p-2 border rounded";
                }
                input.id = `field-${field.key}`;
                input.value = data.fields[field.key] || '';
                
                div.appendChild(label);
                div.appendChild(input);
                fieldsContainer.appendChild(div);
            });
        };

        // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Firebase
        document.getElementById('section-editor-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('editor-save-btn');
            btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'; btn.disabled = true;

            const docId = document.getElementById('editor-doc-id').value;
            const type = document.getElementById('editor-type').value;
            
            // Ø¬Ù…Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
            const tpl = templates[type];
            let newFields = {};
            tpl.editorFields.forEach(f => {
                newFields[f.key] = document.getElementById(`field-${f.key}`).value;
            });

            const payload = {
                menuTitle: document.getElementById('editor-menu-title').value,
                title: document.getElementById('editor-full-title').value,
                order: Number(document.getElementById('editor-order').value),
                type: type,
                fields: newFields
            };

            try {
                if (docId) {
                    // ØªØ­Ø¯ÙŠØ«
                    await updateDoc(doc(db, "sections", docId), payload);
                    showMessage("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­");
                } else {
                    // Ø¬Ø¯ÙŠØ¯
                    await addDoc(collection(db, "sections"), payload);
                    showMessage("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
                }
                document.getElementById('editor-modal').classList.add('hidden');
                await fetchSections(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                renderAdminList();
            } catch (err) {
                console.error(err);
                showMessage("Ø­Ø¯Ø« Ø®Ø·Ø£", "error");
            } finally {
                btn.textContent = 'Ø­ÙØ¸ ÙÙŠ Firebase'; btn.disabled = false;
            }
        });

    </script>
</body>
    </html>
